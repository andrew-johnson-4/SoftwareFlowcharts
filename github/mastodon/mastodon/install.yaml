linux:
  shell: "apt update"
  shell: "apt install -y curl wget gnupg apt-transport-https lsb-release ca-certificates"
  shell: "curl -sL https://deb.nodesource.com/setup_16.x | bash -"
  shell: "wget -O /usr/share/keyrings/postgresql.asc https://www.postgresql.org/media/keys/ACCC4CF8.asc"
  shell: 'echo "deb [signed-by=/usr/share/keyrings/postgresql.asc] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/postgresql.list'
  shell: "apt install -y imagemagick ffmpeg libpq-dev libxml2-dev libxslt1-dev file git-core"
  shell: "apt install -y g++ libprotobuf-dev protobuf-compiler pkg-config nodejs gcc autoconf"
  shell: "apt install -y bison build-essential libssl-dev libyaml-dev libreadline6-dev"
  shell: "apt install -y zlib1g-dev libncurses5-dev libffi-dev libgdbm-dev"
  shell: "apt install -y nginx redis-server redis-tools postgresql postgresql-contrib"
  shell: "apt install -y certbot python3-certbot-nginx libidn11-dev libicu-dev libjemalloc-dev"
  shell: "corepack enable"
  shell: "yarn set version classic"
  shell: "adduser --disabled-login mastodon"
  shell: "su - mastodon"
  shell: "git clone https://github.com/rbenv/rbenv.git ~/.rbenv"
  shell: "cd ~/.rbenv && src/configure && make -C src"
  shell: "echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc"
  shell: "echo 'eval "$(rbenv init -)"' >> ~/.bashrc"
  shell: "exec bash"
  shell: "git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build"
  shell: "RUBY_CONFIGURE_OPTS=--with-jemalloc rbenv install 3.0.6"
  shell: "rbenv global 3.0.6"
  shell: "gem install bundler --no-document"
  shell: "exit"
  shell: "sudo -u postgres psql"
  shell: "CREATE USER mastodon CREATEDB;"
  shell: "\q"
  shell: "su - mastodon"
  shell: "git clone https://github.com/mastodon/mastodon.git live && cd live"
  shell: "git checkout $(git tag -l | grep -v 'rc[0-9]*$' | sort -V | tail -n 1)"
  shell: "bundle config deployment 'true'"
  shell: "bundle config without 'development test'"
  shell: "bundle install -j$(getconf _NPROCESSORS_ONLN)"
  shell: "yarn install --pure-lockfile"
  shell: "exit"
  shell: "cp /home/mastodon/live/dist/nginx.conf /etc/nginx/sites-available/mastodon"
  shell: "ln -s /etc/nginx/sites-available/mastodon /etc/nginx/sites-enabled/mastodon"
  shell: "systemctl reload nginx"
  shell: "certbot --nginx -d {domain}"
  shell: "cp /home/mastodon/live/dist/mastodon-*.service /etc/systemd/system/"
  shell: "systemctl daemon-reload"
  shell: "systemctl enable --now mastodon-web mastodon-sidekiq mastodon-streaming"
  
  
